<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Rotas Ferrovi√°rias - Brasil</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f0f2f5;
            color: #333;
            overflow: hidden;
        }
        
        .container {
            display: flex;
            height: 100vh;
        }
        
        .sidebar {
            width: 350px;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 20px;
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .toolbar {
            background: white;
            padding: 15px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        
        #map {
            flex: 1;
            background-color: #e0e0e0;
        }
        
        .btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn i {
            margin-right: 8px;
        }
        
        .btn:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .btn-danger {
            background-color: #e74c3c;
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .btn-success {
            background-color: #2ecc71;
        }
        
        .btn-success:hover {
            background-color: #27ae60;
        }
        
        .btn-warning {
            background-color: #f39c12;
        }
        
        .btn-warning:hover {
            background-color: #d35400;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }
        
        input, select {
            width: 100%;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #ddd;
            background-color: rgba(255,255,255,0.9);
        }
        
        .station-list, .route-list {
            margin-top: 25px;
        }
        
        .station-item, .route-item {
            background-color: rgba(255,255,255,0.1);
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 4px solid #3498db;
        }
        
        .station-item:hover, .route-item:hover {
            background-color: rgba(255,255,255,0.2);
            transform: translateX(5px);
        }
        
        .station-item.active {
            background-color: rgba(52, 152, 219, 0.3);
            border-left: 4px solid #2ecc71;
        }
        
        .route-item {
            border-left: 4px solid #f39c12;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            padding: 25px;
            border-radius: 10px;
            width: 450px;
            max-width: 90%;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .close {
            font-size: 24px;
            cursor: pointer;
            color: #7f8c8d;
        }
        
        .close:hover {
            color: #34495e;
        }
        
        .mode-indicator {
            background-color: #f39c12;
            padding: 8px 15px;
            border-radius: 20px;
            margin-left: 10px;
            font-weight: bold;
            color: white;
        }
        
        .route-creator {
            position: absolute;
            top: 80px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            display: none;
        }
        
        .instructions {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
            border-left: 4px solid #3498db;
        }
        
        .section-title {
            font-size: 18px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }
        
        .status-bar {
            background-color: #2c3e50;
            color: white;
            padding: 10px 20px;
            font-size: 14px;
        }
        
        .station-marker {
            background-color: #e74c3c;
            border: 3px solid white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        
        .temp-marker {
            background-color: #3498db;
            border: 3px solid white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .logo {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .logo-icon {
            font-size: 24px;
            margin-right: 10px;
        }
        
        .control-group {
            display: flex;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        
        .control-group .btn {
            flex: 1;
            min-width: 120px;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="logo">
                <div class="logo-icon"><i class="fas fa-train"></i></div>
                <h1>Rotas Ferrovi√°rias</h1>
            </div>
            
            <div class="control-group">
                <button id="btn-add-station" class="btn"><i class="fas fa-plus-circle"></i> Esta√ß√£o</button>
                <button id="btn-start-route" class="btn btn-warning"><i class="fas fa-route"></i> Nova Rota</button>
            </div>
            
            <div class="control-group">
                <button id="btn-edit-mode" class="btn"><i class="fas fa-edit"></i> Editar</button>
                <button id="btn-save" class="btn btn-success"><i class="fas fa-save"></i> Salvar</button>
            </div>
            
            <div class="instructions">
                <p><strong>Como criar uma rota:</strong></p>
                <ol>
                    <li>Clique em "Nova Rota"</li>
                    <li>Selecione as esta√ß√µes no mapa na ordem desejada</li>
                    <li>Clique em "Finalizar Rota" quando terminar</li>
                </ol>
            </div>
            
            <div class="station-list">
                <h3 class="section-title"><i class="fas fa-map-marker-alt"></i> Esta√ß√µes</h3>
                <div id="stations-container"></div>
            </div>
            
            <div class="route-list">
                <h3 class="section-title"><i class="fas fa-train"></i> Rotas</h3>
                <div id="routes-container"></div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="toolbar">
                <h2>Mapa Ferrovi√°rio do Brasil</h2>
                <div>
                    <span id="mode-indicator" class="mode-indicator">Modo Visualiza√ß√£o</span>
                </div>
            </div>
            <div id="map"></div>
            <div class="status-bar">
                <span id="status-message">Sistema de gerenciamento de rotas ferrovi√°rias</span>
            </div>
        </div>
    </div>
    
    <!-- Modal para adicionar/editar esta√ß√£o -->
    <div id="station-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title"><i class="fas fa-train-station"></i> Adicionar Esta√ß√£o</h3>
                <span class="close">&times;</span>
            </div>
            <form id="station-form">
                <input type="hidden" id="station-id">
                <div class="form-group">
                    <label for="station-name">Nome da Esta√ß√£o:</label>
                    <input type="text" id="station-name" required>
                </div>
                <div class="form-group">
                    <label for="station-address">Endere√ßo:</label>
                    <input type="text" id="station-address">
                </div>
                <div class="form-group">
                    <label for="station-lat">Latitude:</label>
                    <input type="text" id="station-lat" required>
                </div>
                <div class="form-group">
                    <label for="station-lng">Longitude:</label>
                    <input type="text" id="station-lng" required>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-success"><i class="fas fa-save"></i> Salvar Esta√ß√£o</button>
                    <button type="button" class="btn btn-danger" id="btn-delete-station"><i class="fas fa-trash"></i> Excluir Esta√ß√£o</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Painel de cria√ß√£o de rotas -->
    <div id="route-creator" class="route-creator">
        <h3><i class="fas fa-route"></i> Criando Nova Rota</h3>
        <p>Clique nas esta√ß√µes para adicion√°-las √† rota</p>
        <div class="form-group">
            <label for="route-name">Nome da Rota:</label>
            <input type="text" id="route-name" placeholder="Ex: Rota Sul-Norte">
        </div>
        <div class="control-group">
            <button id="btn-finish-route" class="btn btn-success"><i class="fas fa-check"></i> Finalizar Rota</button>
            <button id="btn-cancel-route" class="btn btn-danger"><i class="fas fa-times"></i> Cancelar</button>
        </div>
        <div id="route-stations-list" style="margin-top: 15px; max-height: 150px; overflow-y: auto;"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        // Vari√°veis globais
        let map;
        let stations = [];
        let routes = [];
        let stationMarkers = [];
        let routeLines = [];
        let editMode = false;
        let selectedStation = null;
        let tempMarker = null;
        let creatingRoute = false;
        let currentRoute = [];
        let currentRouteLine = null;
        
        // Inicializa√ß√£o do mapa
        function initMap() {
            // Coordenadas do centro do Brasil
            const centerLat = -14.2350;
            const centerLng = -51.9253;
            
            // Criar o mapa
            map = L.map('map').setView([centerLat, centerLng], 5);
            
            // Adicionar camada do mapa
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            
            // Carregar dados do servidor
            loadStations();
            loadRoutes();
            
            // Evento de clique no mapa
            map.on('click', function(e) {
                if (editMode && !tempMarker && !creatingRoute) {
                    createTempStation(e.latlng);
                }
            });
        }
        
        // Carregar esta√ß√µes do servidor
        function loadStations() {
            fetch('api.php?action=get_stations')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Erro na resposta do servidor');
                    }
                    return response.json();
                })
                .then(data => {
                    stations = data;
                    renderStations();
                    updateStatus("Esta√ß√µes carregadas com sucesso");
                })
                .catch(error => {
                    console.error('Erro ao carregar esta√ß√µes:', error);
                    updateStatus("Erro ao carregar esta√ß√µes");
                });
        }
        
        // Carregar rotas do servidor
        function loadRoutes() {
            fetch('api.php?action=get_routes')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Erro na resposta do servidor');
                    }
                    return response.json();
                })
                .then(data => {
                    routes = data;
                    renderRoutes();
                    updateStatus("Rotas carregadas com sucesso");
                })
                .catch(error => {
                    console.error('Erro ao carregar rotas:', error);
                    updateStatus("Erro ao carregar rotas");
                });
        }
        
        // Criar esta√ß√£o tempor√°ria no mapa
        function createTempStation(latlng) {
            tempMarker = L.marker(latlng, {
                draggable: true,
                icon: L.divIcon({
                    className: 'temp-marker',
                    html: '<div style="background-color: #3498db; width: 18px; height: 18px; border-radius: 50%; border: 3px solid white;"></div>',
                    iconSize: [24, 24]
                })
            }).addTo(map);
            
            // Preencher coordenadas no formul√°rio
            document.getElementById('station-lat').value = latlng.lat.toFixed(6);
            document.getElementById('station-lng').value = latlng.lng.toFixed(6);
            
            // Abrir modal para adicionar esta√ß√£o
            openStationModal();
        }
        
        // Renderizar esta√ß√µes no mapa e na lista
        function renderStations() {
            // Limpar marcadores existentes
            stationMarkers.forEach(marker => map.removeLayer(marker));
            stationMarkers = [];
            
            // Limpar lista de esta√ß√µes
            const container = document.getElementById('stations-container');
            container.innerHTML = '';
            
            // Adicionar cada esta√ß√£o
            stations.forEach(station => {
                // Criar marcador no mapa
                const marker = L.marker([station.latitude, station.longitude], {
                    draggable: editMode,
                    icon: L.divIcon({
                        className: 'station-marker',
                        html: '<div style="background-color: #e74c3c; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white;"></div>',
                        iconSize: [26, 26]
                    })
                }).addTo(map);
                
                // Adicionar popup com informa√ß√µes
                marker.bindPopup(`
                    <div>
                        <h3>${station.nome}</h3>
                        <p>${station.endereco || 'Sem endere√ßo'}</p>
                        <button onclick="editStation(${station.id})" class="btn" style="margin-top: 10px;">Editar</button>
                    </div>
                `);
                
                // Evento de arrastar (apenas no modo edi√ß√£o)
                if (editMode) {
                    marker.on('dragend', function(e) {
                        const newLat = e.target.getLatLng().lat;
                        const newLng = e.target.getLatLng().lng;
                        updateStationPosition(station.id, newLat, newLng);
                    });
                }
                
                // Evento de clique
                marker.on('click', function() {
                    if (creatingRoute) {
                        addStationToRoute(station);
                    } else if (editMode) {
                        selectStation(station.id);
                    } else {
                        map.setView([station.latitude, station.longitude], 10);
                        marker.openPopup();
                    }
                });
                
                stationMarkers.push(marker);
                
                // Adicionar √† lista lateral
                const stationItem = document.createElement('div');
                stationItem.className = 'station-item';
                stationItem.innerHTML = `
                    <strong>${station.nome}</strong>
                    <div style="font-size: 12px; margin-top: 5px;">${station.endereco || ''}</div>
                `;
                stationItem.dataset.id = station.id;
                
                stationItem.addEventListener('click', function() {
                    if (creatingRoute) {
                        addStationToRoute(station);
                    } else if (editMode) {
                        selectStation(station.id);
                    } else {
                        map.setView([station.latitude, station.longitude], 10);
                        marker.openPopup();
                    }
                });
                
                container.appendChild(stationItem);
            });
        }
        
        // Renderizar rotas no mapa
        function renderRoutes() {
            // Limpar rotas existentes
            routeLines.forEach(line => map.removeLayer(line));
            routeLines = [];
            
            // Limpar lista de rotas
            const container = document.getElementById('routes-container');
            container.innerHTML = '';
            
            // Adicionar cada rota
            routes.forEach(route => {
                // Obter coordenadas das esta√ß√µes da rota
                const coordinates = [];
                route.estacoes.forEach(estacao => {
                    coordinates.push([estacao.latitude, estacao.longitude]);
                });
                
                if (coordinates.length > 1) {
                    // Criar linha da rota com estilo de trilho
                    const line = L.polyline(coordinates, {
                        color: '#333',
                        weight: 6,
                        opacity: 0.8,
                        dashArray: '10, 10'
                    }).addTo(map);
                    
                    // Linha de sombra para efeito de trilho
                    const shadowLine = L.polyline(coordinates, {
                        color: '#e74c3c',
                        weight: 8,
                        opacity: 0.3
                    }).addTo(map);
                    
                    // Adicionar popup com informa√ß√µes
                    line.bindPopup(`
                        <div>
                            <h3>${route.nome}</h3>
                            <p>Dist√¢ncia: ${route.distancia_km} km</p>
                            <p>Tempo estimado: ${route.tempo_estimado_min} min</p>
                            <p>Esta√ß√µes: ${route.estacoes.length}</p>
                            <button onclick="deleteRoute(${route.id})" class="btn btn-danger" style="margin-top: 10px;">Excluir Rota</button>
                        </div>
                    `);
                    
                    routeLines.push(line);
                    routeLines.push(shadowLine);
                    
                    // Adicionar √† lista lateral
                    const routeItem = document.createElement('div');
                    routeItem.className = 'route-item';
                    routeItem.innerHTML = `
                        <strong>${route.nome}</strong>
                        <div style="font-size: 12px; margin-top: 5px;">
                            Dist√¢ncia: ${route.distancia_km} km | 
                            Tempo: ${Math.floor(route.tempo_estimado_min / 60)}h ${route.tempo_estimado_min % 60}min
                        </div>
                        <div style="font-size: 11px; margin-top: 3px;">
                            ${route.estacoes.length} esta√ß√µes
                        </div>
                    `;
                    
                    routeItem.addEventListener('click', function() {
                        if (coordinates.length > 0) {
                            map.fitBounds(coordinates);
                        }
                    });
                    
                    container.appendChild(routeItem);
                }
            });
        }
        
        // Alternar modo de edi√ß√£o
        function toggleEditMode() {
            editMode = !editMode;
            
            const indicator = document.getElementById('mode-indicator');
            const btn = document.getElementById('btn-edit-mode');
            
            if (editMode) {
                indicator.textContent = 'Modo Edi√ß√£o';
                indicator.style.backgroundColor = '#e74c3c';
                btn.innerHTML = '<i class="fas fa-eye"></i> Visualizar';
                updateStatus("Modo edi√ß√£o ativado - Voc√™ pode mover esta√ß√µes");
            } else {
                indicator.textContent = 'Modo Visualiza√ß√£o';
                indicator.style.backgroundColor = '#f39c12';
                btn.innerHTML = '<i class="fas fa-edit"></i> Editar';
                updateStatus("Modo visualiza√ß√£o ativado");
            }
            
            renderStations();
        }
        
        // Iniciar cria√ß√£o de rota
        function startRouteCreation() {
            creatingRoute = true;
            currentRoute = [];
            
            document.getElementById('route-creator').style.display = 'block';
            updateStatus("Criando nova rota - Clique nas esta√ß√µes para adicion√°-las √† rota");
            map.getContainer().style.cursor = 'crosshair';
        }
        
        // Finalizar cria√ß√£o de rota
        function finishRouteCreation() {
            const routeName = document.getElementById('route-name').value || `Rota ${routes.length + 1}`;
            
            if (currentRoute.length < 2) {
                alert('Uma rota precisa ter pelo menos duas esta√ß√µes');
                return;
            }
            
            // Preparar dados para envio
            const data = {
                nome: routeName,
                estacoes: JSON.stringify(currentRoute.map(station => station.id))
            };
            
            // Enviar para o servidor
            fetch('api.php?action=save_route', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Erro na resposta do servidor');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    cancelRouteCreation();
                    loadRoutes();
                    updateStatus(`Rota "${routeName}" criada com sucesso`);
                } else {
                    alert('Erro ao salvar rota: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Erro ao salvar rota: ' + error.message);
            });
        }
        
        // Cancelar cria√ß√£o de rota
        function cancelRouteCreation() {
            creatingRoute = false;
            currentRoute = [];
            
            document.getElementById('route-creator').style.display = 'none';
            map.getContainer().style.cursor = '';
            
            if (currentRouteLine) {
                map.removeLayer(currentRouteLine);
                currentRouteLine = null;
            }
            
            updateStatus("Cria√ß√£o de rota cancelada");
        }
        
        // Adicionar esta√ß√£o √† rota em cria√ß√£o
        function addStationToRoute(station) {
            if (currentRoute.some(s => s.id === station.id)) {
                updateStatus("Esta esta√ß√£o j√° est√° na rota");
                return;
            }
            
            currentRoute.push(station);
            updateRouteStationsList();
            updateTempRouteLine();
            updateStatus(`Esta√ß√£o "${station.nome}" adicionada √† rota`);
        }
        
        // Atualizar lista de esta√ß√µes na rota em cria√ß√£o
        function updateRouteStationsList() {
            const container = document.getElementById('route-stations-list');
            container.innerHTML = '';
            
            currentRoute.forEach((station, index) => {
                const stationItem = document.createElement('div');
                stationItem.style.padding = '5px';
                stationItem.style.borderBottom = '1px solid #eee';
                stationItem.innerHTML = `${index + 1}. ${station.nome}`;
                container.appendChild(stationItem);
            });
        }
        
        // Atualizar linha tempor√°ria da rota em cria√ß√£o
        function updateTempRouteLine() {
            if (currentRouteLine) {
                map.removeLayer(currentRouteLine);
            }
            
            if (currentRoute.length > 1) {
                const coordinates = currentRoute.map(station => [station.latitude, station.longitude]);
                
                currentRouteLine = L.polyline(coordinates, {
                    color: '#3498db',
                    weight: 4,
                    opacity: 0.7,
                    dashArray: '5, 5'
                }).addTo(map);
            }
        }
        
        // Selecionar esta√ß√£o
        function selectStation(stationId) {
            document.querySelectorAll('.station-item').forEach(item => {
                item.classList.remove('active');
            });
            
            selectedStation = stationId;
            
            if (stationId) {
                const stationItem = document.querySelector(`.station-item[data-id="${stationId}"]`);
                if (stationItem) {
                    stationItem.classList.add('active');
                }
            }
        }
        
        // Abrir modal de esta√ß√£o
        function openStationModal(stationId = null) {
            const modal = document.getElementById('station-modal');
            const title = document.getElementById('modal-title');
            const form = document.getElementById('station-form');
            const deleteBtn = document.getElementById('btn-delete-station');
            
            if (stationId) {
                title.innerHTML = '<i class="fas fa-train-station"></i> Editar Esta√ß√£o';
                const station = stations.find(s => s.id == stationId);
                
                if (station) {
                    document.getElementById('station-id').value = station.id;
                    document.getElementById('station-name').value = station.nome;
                    document.getElementById('station-address').value = station.endereco || '';
                    document.getElementById('station-lat').value = station.latitude;
                    document.getElementById('station-lng').value = station.longitude;
                }
                
                deleteBtn.style.display = 'inline-block';
            } else {
                title.innerHTML = '<i class="fas fa-train-station"></i> Adicionar Esta√ß√£o';
                form.reset();
                document.getElementById('station-id').value = '';
                deleteBtn.style.display = 'none';
                
                if (!document.getElementById('station-lat').value) {
                    const center = map.getCenter();
                    document.getElementById('station-lat').value = center.lat.toFixed(6);
                    document.getElementById('station-lng').value = center.lng.toFixed(6);
                }
            }
            
            modal.style.display = 'flex';
        }
        
        // Editar esta√ß√£o
        function editStation(stationId) {
            openStationModal(stationId);
        }
        
        // Fechar modais
        function closeModals() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.style.display = 'none';
            });
            
            if (tempMarker) {
                map.removeLayer(tempMarker);
                tempMarker = null;
            }
        }
        
        // Salvar esta√ß√£o
        function saveStation(event) {
            event.preventDefault();
            
            const data = {
                id: document.getElementById('station-id').value,
                nome: document.getElementById('station-name').value,
                endereco: document.getElementById('station-address').value,
                latitude: document.getElementById('station-lat').value,
                longitude: document.getElementById('station-lng').value
            };
            
            fetch('api.php?action=save_station', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Erro na resposta do servidor');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    closeModals();
                    loadStations();
                    updateStatus(`Esta√ß√£o "${document.getElementById('station-name').value}" salva com sucesso`);
                } else {
                    alert('Erro ao salvar esta√ß√£o: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Erro ao salvar esta√ß√£o: ' + error.message);
            });
        }
        
        // Excluir esta√ß√£o
        function deleteStation() {
            const stationId = document.getElementById('station-id').value;
            
            if (!stationId || !confirm('Tem certeza que deseja excluir esta esta√ß√£o?')) {
                return;
            }
            
            const data = {
                id: stationId
            };
            
            fetch('api.php?action=delete_station', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Erro na resposta do servidor');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    closeModals();
                    loadStations();
                    updateStatus("Esta√ß√£o exclu√≠da com sucesso");
                } else {
                    alert('Erro ao excluir esta√ß√£o: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Erro ao excluir esta√ß√£o: ' + error.message);
            });
        }
        
        // Excluir rota
        function deleteRoute(routeId) {
            if (!confirm('Tem certeza que deseja excluir esta rota?')) {
                return;
            }
            
            const data = {
                id: routeId
            };
            
            fetch('api.php?action=delete_route', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Erro na resposta do servidor');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    loadRoutes();
                    updateStatus("Rota exclu√≠da com sucesso");
                } else {
                    alert('Erro ao excluir rota: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Erro ao excluir rota: ' + error.message);
            });
        }
        
        // Atualizar posi√ß√£o da esta√ß√£o
        function updateStationPosition(stationId, lat, lng) {
            const data = {
                id: stationId,
                latitude: lat,
                longitude: lng
            };
            
            fetch('api.php?action=update_station_position', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Erro na resposta do servidor');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    const station = stations.find(s => s.id == stationId);
                    if (station) {
                        updateStatus(`Posi√ß√£o da esta√ß√£o "${station.nome}" atualizada`);
                    }
                }
            })
            .catch(error => {
                console.error('Erro:', error);
            });
        }
        
        // Atualizar mensagem de status
        function updateStatus(message) {
            document.getElementById('status-message').textContent = message;
        }
        
        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar mapa
            initMap();
            
            // Bot√µes
            document.getElementById('btn-add-station').addEventListener('click', function() {
                openStationModal();
            });
            
            document.getElementById('btn-start-route').addEventListener('click', startRouteCreation);
            document.getElementById('btn-finish-route').addEventListener('click', finishRouteCreation);
            document.getElementById('btn-cancel-route').addEventListener('click', cancelRouteCreation);
            
            document.getElementById('btn-edit-mode').addEventListener('click', toggleEditMode);
            
            document.getElementById('btn-save').addEventListener('click', function() {
                // Recarregar dados do servidor
                loadStations();
                loadRoutes();
                updateStatus("Dados atualizados do servidor");
            });
            
            // Fechar modais
            document.querySelectorAll('.close').forEach(closeBtn => {
                closeBtn.addEventListener('click', closeModals);
            });
            
            // Formul√°rios
            document.getElementById('station-form').addEventListener('submit', saveStation);
            document.getElementById('btn-delete-station').addEventListener('click', deleteStation);
            
            // Fechar modal ao clicar fora
            window.addEventListener('click', function(event) {
                if (event.target.classList.contains('modal')) {
                    closeModals();
                }
            });
        });
    </script>
</body>
</html>
index.html
Exibindo trem.sql‚Ä¶Atividades de DS 2024/1 M6 - T√©c. 23 M1 (SUL) 3¬™ S√©rie.
Filtro de t√≥picosFiltro de t√≥picosFiltro de t√≥picos
DESI - Desenvolvimento de Sistemas üíª‚õìÔ∏è‚Äçüí•üñ•Ô∏è
DESI - Desenvolvimento de Sistemas üíª‚õìÔ∏è‚Äçüí•üñ•Ô∏è
Material
√âwerton de Oliveira Cercal postou um novo material: [S.A.] C√≥digo para mapa interativo
Item postado: 29 de out.
Segue c√≥digo em PHP para cria√ß√£o de um mapa interativo que permite a adi√ß√£o de v√°rias esta√ß√µes de trem e conex√£o das rotas entre estas elas.
trem.sql
Desconhecido

api.php
Desconhecido

index.html
HTML

Atividade
JOAO LUIS CORREA BORNELLI postou uma nova atividade: Lista de presen√ßa - 25/10
Data de entrega: 25 de out.
Item postado: 25 de out.
Pendente
Google Forms: Sign-in
https://forms.gle/asXFp2Ce3tNxBx5r5

Material
√âwerton de Oliveira Cercal postou um novo material: [Simulado SAEP] C√≥digos desenvolvidos em sala
Item postado: 25 de out.
Vide anexos.
bd.php
PHP

cadastro_usuario.php
PHP

